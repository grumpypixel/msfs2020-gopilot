<!doctype html>
<!--[if lte IE 9]>
<html class="ie" lang="en">
<![endif]-->
<!--[if gt IE 9]><!-->
<html lang="en">
<!--<![endif]-->
<!-- <html> -->
<head>
<meta charset="utf-8">
<title>SetData</title>
<script src="/assets/js/url-params.js"></script>
<style>
    * {
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    body {
        background-color: white;
        display: flex;
        flex-direction: column;
    }
    #form {
        margin: 16px;
    }
</style>
</head>
<body>
<div align="center">
    <span>Setting data on a Sim Object can crash your Simulator.</span><br/>
    <span>USE AT YOUR OWN RISK!</span>
</div>
    <div id="form" align="center">
    <table>
        <tr>
            <td><label for="name">SimVar:&nbsp;</label></td>
            <td><input type="text" id="name" /></td>
        </tr>
        <tr>
            <td><label for="name">Unit:&nbsp;</label></td>
            <td><input type="text" id="unit" /></td>
        </tr>
        <tr>
            <td><label for="name">Value:&nbsp;</label></td>
            <td><input type="number" id="value" /></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td><button type="button" onclick="prepareMessage()">Send</button></td>
        </tr>
</table>
</div>
<script>
function prepareMessage() {
    name = document.getElementById("name").value;
    unit = document.getElementById("unit").value;
    value = document.getElementById("value").value;
    value = parseFloat(value);

    console.log(`name: ${name} unit: ${unit} value: ${value}`);

    if (isNaN(value) === true) {
        return;
    }
    data = {
        name,
        unit,
        value: value
    };
    meta = 'nil';
    sendMessage('setdata', data, meta);
}
</script>

<script>
const constants = {
    webSocketSupport: 'WebSocket' in window,
    webSocketAddress: 'ws://' + window.location.hostname + ':' + window.location.port + '/ws',
};

const vars = {
    socket: null,
    urlParams: {},
};

const elements = {
};

const dataTypes = {
    int32: "int32",
    int64: "int64",
    float32: "float32",
    float64: "float64",
    string256: "string256",
}

const units = {
    degrees: 'degrees',
    feet: 'feet',
    ft_min: 'ft/min',
    knot: 'knot',
    percent: 'percent',
};

window.onload = () => {
    vars.urlParams = getUrlParameters();
    if (constants.webSocketSupport === true) {
        vars.socket = new WebSocket(constants.webSocketAddress);
        handleWebSocketEvents();
    }
    initElements();
}

window.onbeforeunload = () => {
    if (constants.webSocketSupport === true) {
        vars.socket.onclose = () => {};
        vars.socket.close();
    }
};

function initElements() {
    // elements.followPlane = document.getElementById('follow_plane');
}

function handleWebSocketEvents() {
    vars.socket.onopen = () => {
        console.log('connected.');
    };
    vars.socket.onclose = () => {
        console.log('disconnected.');
    };
    vars.socket.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        // console.log(msg);
    };
}

function sendMessage(name, data, meta) {
    const msg = {type: name, data, meta, debug: 0};
    console.log(JSON.stringify(msg));
    sendData(JSON.stringify(msg));
}

function sendData(data) {
    if (constants.webSocketSupport === true) {
        vars.socket.send(data);
    }
}

// function getSimVars() {
//     return [
//         {name: 'PLANE HEADING DEGREES TRUE', unit: units.degrees, type: dataTypes.float64, moniker: monikers.headingTrue},
//         {name: 'PLANE LATITUDE', unit: units.degrees, type: dataTypes.float64, moniker: monikers.latitude},
//         {name: 'PLANE LONGITUDE', unit: units.degrees, type: dataTypes.float64, moniker: monikers.longitude},
//     ];
// }
</script>
</body>
</html>
